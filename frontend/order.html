<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Orders - Adama Shopping</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background-color: #f8f8f8; }
  h1 { margin-bottom: 20px; }

  a.button-link {
    display: inline-block;
    padding: 10px 20px;
    margin: 5px;
    background-color: #007bff;
    color: white;
    text-decoration: none;
    border-radius: 5px;
  }
  a.button-link:hover { background-color: #0056b3; }

  .order-card {
    border:1px solid #ccc;
    padding:10px;
    margin:10px 0;
    display: flex;
    gap: 15px;
    border-radius: 6px;
    background-color: #fff;
  }

  .post-img {
    width: 150px;
    height: 150px;
    object-fit: cover;
    border-radius: 6px;
  }

  .order-details p { margin: 2px 0; }

  .seller-info {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
  }

  .seller-pic {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
  }

  .seller-bank {
    margin-top: 5px;
    font-size: 14px;
    color: #333;
  }

  .status { font-weight: bold; margin-top: 5px; }

  .total-price {
    margin-top: 20px;
    font-size: 20px;
    font-weight: bold;
    color: #007bff;
  }

  /* Popup modal */
  .popup {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .popup-content {
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    width: 400px;
    text-align: left;
  }
  .popup input {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    margin-bottom: 10px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  .popup button {
    padding: 8px 12px;
    margin-top: 5px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  .submit-btn { background-color: #007bff; color: white; }
  .close-btn { background-color: #ccc; color: black; margin-left: 10px; }
</style>
</head>
<body>

<h1>My Orders</h1>
<a href="home.html" class="button-link">Back to Home</a>

<div id="ordersContainer"></div>
<div id="totalPriceDiv" class="total-price"></div>

<!-- Popup Modal -->
<div id="paymentPopup" class="popup">
  <div class="popup-content">
    <h3>Payment Information</h3>
    <p><strong>Seller Bank Name:</strong> <span id="popupSellerBankName"></span></p>
    <p><strong>Seller Bank Number:</strong> <span id="popupSellerBankNumber"></span></p>
    <hr>
    <label>Your Bank Name:</label>
    <input type="text" id="userBankName" placeholder="Enter your bank name">
    <label>Your Bank Number:</label>
    <input type="text" id="userBankNumber" placeholder="Enter your bank number">
    <div style="margin-top:10px;">
      <button id="submitPayment" class="submit-btn">Submit Payment Info</button>
      <button id="closePopup" class="close-btn">Close</button>
    </div>
  </div>
</div>

<script>
const ordersContainer = document.getElementById('ordersContainer');
const totalPriceDiv = document.getElementById('totalPriceDiv');
const popup = document.getElementById('paymentPopup');
const popupSellerBankName = document.getElementById('popupSellerBankName');
const popupSellerBankNumber = document.getElementById('popupSellerBankNumber');
const submitPaymentBtn = document.getElementById('submitPayment');
const closePopupBtn = document.getElementById('closePopup');
let selectedOrder = null;

const storedUser = localStorage.getItem('currentUser');
if (!storedUser) window.location.href = 'login.html';
const currentUser = JSON.parse(storedUser);

async function loadOrders() {
  ordersContainer.innerHTML = '<p>Loading your orders...</p>';
  try {
    const res = await fetch(`https://adama-shopping-20ij.onrender.com/api/orders/buyer/${currentUser.info.username}`);
    const data = await res.json();
    if (!res.ok && data.error) throw new Error(data.error);

    const orders = data.orders || [];
    if (orders.length === 0) {
      ordersContainer.innerHTML = '<p>You have no orders yet.</p>';
      totalPriceDiv.innerHTML = '';
      return;
    }
    displayOrders(orders);
  } catch (err) {
    console.error(err);
    ordersContainer.innerHTML = `<p style="color:red;">Error loading orders: ${err.message}</p>`;
  }
}

function displayOrders(orders) {
  let html = '';
  let totalPrice = 0;

  orders.forEach((order) => {
    const orderTotal = (order.price || 0) * (order.quantity || 1);
    totalPrice += orderTotal;

    html += `
      <div class="order-card">
        <div>
          <img src="${order.image || '/uploads/default-profile.png'}" class="post-img" alt="Ordered Image">
        </div>
        <div class="order-details">
          <h3>${order.title}</h3>
          <p><strong>Description:</strong> ${order.description || 'N/A'}</p>
          <p><strong>Price:</strong> ${order.price}</p>
          <p><strong>Quantity:</strong> ${order.quantity}</p>
          <p><strong>Order Total:</strong> ${orderTotal}</p>
          <p class="status"><strong>Status:</strong> ${order.status || 'Pending'}</p>
          <div class="seller-info">
            <img src="${order.sellerProfilePic || '/uploads/default-profile.png'}" alt="Seller" class="seller-pic">
            <div>
              <p><strong>${order.sellerFullName}</strong> (@${order.sellerUsername})</p>
              <div class="seller-bank">
                <p><strong>Bank Name:</strong> ${order.sellerBankName}</p>
                <p><strong>Bank Number:</strong> ${order.sellerBankNumber}</p>
              </div>
            </div>
          </div>
          <button class="payment-btn" 
            data-seller-bank-name="${order.sellerBankName}" 
            data-seller-bank-number="${order.sellerBankNumber}" 
            data-seller-username="${order.sellerUsername}" 
            data-order-id="${order._id}"
            data-order-title="${order.title}"
            data-order-description="${order.description || ''}"
            data-order-image="${order.image || '/uploads/default-profile.png'}"
            style="margin-top:10px;background-color:#28a745;color:white;padding:5px 10px;border:none;border-radius:5px;cursor:pointer;">
            Add Payment Info
          </button>
        </div>
      </div>`;
  });

  ordersContainer.innerHTML = html;
  totalPriceDiv.innerHTML = `Total Price of All Orders: ${totalPrice}`;

  document.querySelectorAll('.payment-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      selectedOrder = btn;
      popupSellerBankName.textContent = btn.dataset.sellerBankName;
      popupSellerBankNumber.textContent = btn.dataset.sellerBankNumber;
      popup.style.display = 'flex';
    });
  });
}

closePopupBtn.addEventListener('click', () => popup.style.display = 'none');

submitPaymentBtn.addEventListener('click', async () => {
  const userBankName = document.getElementById('userBankName').value.trim();
  const userBankNumber = document.getElementById('userBankNumber').value.trim();
  if (!userBankName || !userBankNumber) return alert('Please fill in your bank name and number.');

  const paymentData = {
    buyerUsername: currentUser.info.username,
    buyerFullName: currentUser.info.fullName || '',
    buyerProfilePic: currentUser.info.profilePic || '/uploads/default-profile.png',
    sellerUsername: selectedOrder.dataset.sellerUsername,
    sellerBankName: selectedOrder.dataset.sellerBankName,
    sellerBankNumber: selectedOrder.dataset.sellerBankNumber,
    userBankName,
    userBankNumber,
    orderId: selectedOrder.dataset.orderId,
    orderTitle: selectedOrder.dataset.orderTitle,
    orderDescription: selectedOrder.dataset.orderDescription,
    orderImage: selectedOrder.dataset.orderImage
  };

  try {
    const res = await fetch('https://adama-shopping-20ij.onrender.com/api/payments', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(paymentData)
    });
    const data = await res.json();
    if (res.ok) {
      alert('✅ Payment Info Submitted and saved to MongoDB!');
      popup.style.display = 'none';
    } else {
      alert('❌ Error submitting payment: ' + (data.error || 'Server error'));
    }
  } catch (err) {
    alert('⚠️ Error submitting payment: ' + err.message);
  }
});

loadOrders();
</script>

</body>
</html>
